#
# Stack User Yaml for Geodesy
#
keypair: 'geodesy'
autoscaling_units:
  -
    unit_title: OpenAM
    asg_config:
       image_id: "ami-ffccf79c"
       instance_type: 't2.small'
       userdata: |
         #!/usr/bin/env bash

         # Set up iptables restricted access and redirection of port 80 to port 8080
         yum install iptables-services -y
         service iptables start
         iptables -I INPUT -p tcp --dport 80 -j ACCEPT
         iptables -I INPUT -p tcp --dport 8080 -j ACCEPT
         iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
         iptables -t nat -A OUTPUT -o lo -p tcp --dport 80 -j REDIRECT --to-port 8080
         service iptables save

         service tomcat8 start

    elb_config:
      elb_listeners_config:
        -
          instance_protocol: 'HTTP'
          instance_port: '8080'
          loadbalancer_protocol: 'HTTP'
          loadbalancer_port: '80'
      ssl_certificate_id: 'arn:aws:acm:ap-southeast-2:094928090547:certificate/07496dcd-6975-4dd4-8986-533488587f0e'
      elb_health_check: 'HTTP:8080/openam/images/gradlogsides.jpg'

ec2_scheduled_shutdown: {{ ec2_scheduled_shutdown }}
